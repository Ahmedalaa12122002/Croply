from telegram import Update
from telegram.ext import ContextTypes
from sqlalchemy import select

from database import AsyncSessionLocal
from models import User
from handlers.callbacks import USER_STATES
from handlers.permissions import get_user_role


async def handle_messages(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© Ø¯Ø§Ø®Ù„ Ø¨ÙˆØª Ø§Ù„Ø£Ø¯Ù…Ù†
    (Ù…Ø«Ù„ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø­Ø«)
    """

    telegram_user_id = update.effective_user.id
    text = update.message.text.strip()

    # ğŸ” ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    role = await get_user_role(telegram_user_id)
    if not role:
        await update.message.reply_text("â›” ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª")
        return

    # ğŸ•’ Ù‡Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ IDØŸ
    if USER_STATES.get(telegram_user_id) != "WAITING_ID":
        # ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        return

    # âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù€ ID
    if not text.isdigit():
        await update.message.reply_text("âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¨Ø¹Øª Telegram ID ØµØ­ÙŠØ­ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)")
        return

    target_user_id = int(text)

    # ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async with AsyncSessionLocal() as session:
        result = await session.execute(
            select(User).where(User.telegram_id == target_user_id)
        )
        user = result.scalar_one_or_none()

    # ğŸ§¹ Ø¥Ø²Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    USER_STATES.pop(telegram_user_id, None)

    # âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
    if not user:
        await update.message.reply_text("âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
        return

    # âœ… Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    message = (
        "ğŸ‘¤ **Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…**\n\n"
        f"ğŸ†” ID: `{user.telegram_id}`\n"
        f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user.first_name or 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\n"
        f"ğŸ“› ÙŠÙˆØ²Ø±Ù†ÙŠÙ…: @{user.username if user.username else 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}\n"
        f"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: {user.created_at}\n"
    )

    await update.message.reply_text(
        message,
        parse_mode="Markdown"
    )
